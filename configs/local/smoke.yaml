# Smoke Test: TCN + Bi-Mamba + GNN Stack (V3)
# Quick validation (1 epoch) for pipeline testing on RTX 4090
#
# IMPORTANT: Must run with environment variables:
#   export BGB_LIMIT_FILES=3
#   export BGB_SMOKE_TEST=1
#
# Usage: BGB_LIMIT_FILES=3 BGB_SMOKE_TEST=1 python -m src train configs/local/smoke.yaml
#
# To enable PR-1 normalization: set model.norms.boundary_norm to "layernorm" (default: "none")

experiment:
  name: smoke_test
  description: "Stack smoke test - TCN+BiMamba+GNN"
  seed: 42
  output_dir: results/smoke
  device: cuda

model:
  architecture: v3  # V3 dual-stream with learned adjacency

  tcn:
    num_layers: 8
    kernel_size: 7
    dropout: 0.15
    causal: false
    stride_down: 16
    use_cuda_optimizations: true

  mamba:
    n_layers: 6
    d_model: 512
    d_state: 16
    conv_kernel: 4  # CUDA constraint: must be 2-4
    dropout: 0.1

  graph:
    enabled: true
    edge_features: cosine
    edge_top_k: 3
    edge_threshold: 1.0e-4
    edge_mamba_layers: 2
    edge_mamba_d_state: 8
    edge_mamba_d_model: 16

    # PR-2: BOUNDED EDGE STREAM (disabled by default)
    # To enable: change edge_lift_activation from "none" to "tanh"
    edge_lift_activation: tanh  # Options: tanh | sigmoid | selu | none  # PR-2 ENABLED
    edge_lift_norm: layernorm  # Options: layernorm | rmsnorm | none  # PR-2 ENABLED
    edge_lift_init_gain: 0.1

    # PR-3: ADJACENCY CONDITIONING (disabled by default)
    # To enable: set adj_row_softmax: true and adj_force_symmetric: true
    adj_row_softmax: true  # Apply masked row-wise softmax  # PR-3 ENABLED
    adj_softmax_tau: 1.0  # Temperature for softmax
    adj_ema_beta: 0.9  # EMA coefficient (null=disabled, 0.9=recommended)  # PR-3 ENABLED
    adj_force_symmetric: true  # Force symmetric adjacency  # PR-3 ENABLED
    laplacian_eps: 1.0e-3  # Laplacian regularization  # PR-3 increased for stability
    laplacian_normalize: true  # Use normalized Laplacian

    n_layers: 2
    dropout: 0.1
    use_residual: true
    alpha: 0.05
    k_eigenvectors: 16
    use_dynamic_pe: true
    semi_dynamic_interval: 10
    pe_sign_consistency: true

  # PR-1: BOUNDARY NORMALIZATION (disabled by default)
  # To enable: change boundary_norm from "none" to "layernorm"
  norms:
    boundary_norm: layernorm  # Options: layernorm | rmsnorm | none  # PR-1 ENABLED
    boundary_eps: 1.0e-5
    layerscale_alpha: 0.1
    after_tcn_proj: true
    after_node_mamba: true
    after_edge_mamba: true
    after_gnn: true
    before_decoder: true

data:
  dataset: tuh_eeg
  data_dir: data_ext4/tusz/edf
  cache_dir: cache/tusz
  split_policy: official_tusz
  sampling_rate: 256
  n_channels: 19
  window_size: 60
  stride: 10
  use_balanced_sampling: false  # MUST be false for BGB_LIMIT_FILES to work!
  num_workers: 0  # WSL2 stability
  pin_memory: false
  persistent_workers: false
  prefetch_factor: 2
  validation_split: 0.2

preprocessing:
  montage: "10-20"
  bandpass: [0.5, 120.0]
  notch_freq: 60
  normalize: true
  use_mne: true

training:
  epochs: 1
  batch_size: 8
  learning_rate: 5.0e-5
  weight_decay: 0.05
  optimizer: adamw
  gradient_clip: 0.5
  mixed_precision: false  # Disabled for RTX 4090 stability

  loss: focal
  focal_alpha: 0.5
  focal_gamma: 2.0

  scheduler:
    type: cosine
    warmup_ratio: 0.1

  early_stopping:
    patience: 5
    metric: sensitivity_at_10fa

postprocessing:
  hysteresis:
    tau_on: 0.86
    tau_off: 0.78
  morphology:
    opening_kernel: 11
    closing_kernel: 31
  duration:
    min_duration_s: 3.0
    max_duration_s: 600.0
  events:
    tau_merge: 2.0
    confidence_method: mean

evaluation:
  metrics: [taes, sensitivity, specificity, auroc]
  fa_rates: [10, 5, 2.5, 1]
  save_predictions: false
  save_plots: false

logging:
  log_every_n_steps: 10
  log_gradients: false
  log_weights: false